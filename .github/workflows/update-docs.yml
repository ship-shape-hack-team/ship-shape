name: Update GitHub Pages Documentation

on:
  workflow_dispatch:
    inputs:
      revision_reason:
        description: 'Reason for documentation update'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  update-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create documentation update issue
        id: create-issue
        uses: actions/github-script@v7
        env:
          REVISION_REASON: ${{ github.event.inputs.revision_reason }}
          ACTOR: ${{ github.actor }}
        with:
          script: |
            const revisionReason = process.env.REVISION_REASON;
            const actor = process.env.ACTOR;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'docs: Update GitHub Pages documentation',
              body: `## Documentation Update Request

**Reason**: ${revisionReason}

**Triggered by**: @${actor}

**Action Required**:
This workflow creates a reminder to update the GitHub Pages documentation using the \`github-pages-docs\` agent in Claude Code.

### Steps to Update Documentation:

1. **Open Claude Code** in this repository
2. **Run the command**:
   \`\`\`
   Use the @agent-github-pages-docs to revise all documentation in docs/ based on:
   - Latest CLAUDE.md updates
   - Bootstrap feature implementation status
   - Recent code changes
   - ${revisionReason}
   \`\`\`
3. **Review the changes** generated by the agent
4. **Commit and push** to this branch or create a PR
5. **Close this issue** when complete

### Why Manual Update?

The \`github-pages-docs\` agent requires Claude Code's specialized documentation capabilities. We're tracking this issue to ensure documentation stays synchronized with codebase changes.

### Future Automation

See \`BACKLOG.md\` - "Documentation Source Truth and Cascade System" (P2) for plans to automate this workflow.

---

**Related Files**:
- \`docs/\` - GitHub Pages documentation
- \`CLAUDE.md\` - Project guide (source of truth)
- \`README.md\` - User-facing documentation
- \`agent-ready-codebase-attributes.md\` - Research report (source of truth)

**Labels**: documentation, automation-needed, agent-task
              `,
              labels: ['documentation', 'automation-needed', 'agent-task']
            });

            core.setOutput('issue_number', issue.data.number);
            core.notice(`Created documentation update issue #${issue.data.number}`);
            return issue.data.number;

      - name: Check for recent source file changes
        id: check_changes
        run: |
          # Check for recent changes to source-of-truth files (last 7 days)
          CHANGES=$(git log --oneline --since="7 days ago" -- \
            CLAUDE.md \
            README.md \
            agent-ready-codebase-attributes.md \
            src/agentready/cli/bootstrap.py \
            src/agentready/services/bootstrap.py \
            || true)

          if [ -n "$CHANGES" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            # Save to file to avoid injection issues
            echo "$CHANGES" > /tmp/recent_changes.txt
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment with recent changes
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const recentChanges = fs.readFileSync('/tmp/recent_changes.txt', 'utf-8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create-issue.outputs.issue_number }},
              body: `### Recent Changes to Source Files

The following commits may affect documentation:

\`\`\`
${recentChanges}
\`\`\`

Please ensure the documentation agent incorporates these changes.
              `
            });

      - name: Summary
        env:
          ISSUE_NUMBER: ${{ steps.create-issue.outputs.issue_number }}
        run: |
          echo "âœ… Created documentation update issue #${ISSUE_NUMBER}"
          echo ""
          echo "Next steps:"
          echo "1. Open Claude Code in this repository"
          echo "2. Use @agent-github-pages-docs to update documentation"
          echo "3. Review and commit changes"
          echo "4. Close issue #${ISSUE_NUMBER}"
